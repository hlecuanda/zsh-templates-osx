#!/bin/zsh -f

# Obtained and modified from a bash shell script available at
# http://www.osxfaq.com/tips/unix-tricks/week91/friday.ws

# Delete a user.
# Takes the account name (short name) and:
#   removes the user from all groups
#   removes the user's primary group (of the same name)
#   removes the user's account in NetInfo
#   archives and deletes the user's home directory in /Users/shortname

commandname=$0

declare user  # to hold user's account name
declare str   # working


function usage {
  print "Delete a user account, group, and group membership"
  print "Usage: $commandname username"
  if [[ "$*" != "" ]]; then print ""; print "Error: $*"; fi
  return 1
}


# The script must be run as root 
#
if [[ "$USER" != "root" ]]; then
  print "Must be run as root (type \"sudo zsh\" ) "
  return 1
fi


# Check parameters
#
if [[ $# -ne 1 ]]; then
  usage
  return 1
fi

user="$1"

# search NetInfo for the given user - it should exist
str="$(nifind /users/$user .)"
if [[  -z "$str" ]]; then
  usage "User $user does not exist"
  return 1
fi

# Delete the user from NetInfo
#
# delete the user from all groups

autoload -U remove_user_from_group
remove_user_from_group all $user

# delete the user's primary group
autoload -U delete_group
delete_group -q $user

# delete the user from NetInfo
dscl . delete /users/$user

print "User $user deleted"

# Archive the user's home directory
#
# check that the user has a home directory
if [[ -e /Users/$user ]]; then
  # archive it
  cd /Users
  tar -czf ${user}-archive.tgz $user
  cd  
  
  # delete it CHECKING THAT AN ARCHIVE WAS CRESATED
  if [[ -e /Users/${user}-archive.tgz ]]; then
    rm -rf /Users/${user}
  fi
fi

print "Users home directory archived and deleted"

return 0

