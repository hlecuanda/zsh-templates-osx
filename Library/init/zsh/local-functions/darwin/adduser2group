#!/bin/zsh -f


# Obtained and modified from a bash shell script available at
# http://www.osxfaq.com/tips/unix-tricks/week91/friday.ws

# Add new users to a an existing group.
# Adds a user (or many users) to an existing group in NetInfo

declare group user  # hold the given group name and user account name
declare gid         # hold the group id derived from the group name
declare str struser stringroup strprimary  # working

commandissued=$0

function usage {
  print "Add a user (or several users) to an existing group"
  print "Usage: $commandissued group user [user...]"
  if [[ "$*" != "" ]]; then echo; echo "Error: $*"; fi
  return 1
}


# Ensure user is root
#
if [[ "$USER" != "root" ]]; then
  echo "Must be run as root (type the command \"sudo zsh\" )"
  return 1
fi


# Check parameters
#
if [[ $# -lt 2 ]]; then
  usage
  return 1
fi

group="$1"

# search NetInfo for the given group - it should exist
str="$(nifind /groups/$group .)"
if [[ -z "$str" ]]; then
  usage "Group $group does not exist"
  return 1
fi

# get the group number from the name
gid="$(nireport . /groups name gid | grep -w "^$group" | cut -f 2)"

# Drop the group and loop thro' additional parameters (users) to add to group
#
shift

for user in $*; do
  # check if the user exists
  struser="$(nifind /users/$user .)"
  # check if the user already belongs to the group
  stringroup="$(nireport . /groups name users | grep -w "^$group" | grep -w "$user")"
  # check if this is the user's primary group
  strprimary="$(nireport . /users name gid | grep -w "^$user" | grep -w "$gid" )"

  # ensure that the user exists...
  if [ -z "$struser" ]; then
    echo "User $user does not exist"
  # ...and does not already belong to the group...
  elif [ ! -z "$stringroup" ]; then
    echo "User $user already belongs to group $group - not added again"
  # ...and this is not the user's primary group
  elif [ ! -z "$strprimary" ]; then
    echo "This is the user's primary group - not added"
  else
    # add user to the group
    dscl . merge /groups/$group users "$user" 
    echo "User $user added to group $group"
  fi
done

return 0

